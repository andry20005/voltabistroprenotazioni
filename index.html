<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Monitor Prenotazioni</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg:#0c1613; --panel:#112521; --panel-2:#0f201c; --line:#2a4a40;
      --text:#f6f7f4; --muted:#cfe1db; --accent:#c8a869; --accent-2:#2e7a62;
      --ok:#8fd0a5; --danger:#ffb3b3;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1512,#0e1b17);color:var(--text);
         font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    header{position:sticky;top:0;z-index:5;background:rgba(16,37,33,.9);backdrop-filter:blur(6px);
           border-bottom:1px solid var(--line);padding:14px 16px;display:flex;gap:12px;align-items:center;justify-content:space-between}
    h1{margin:0;font-size:1.15rem;letter-spacing:.2px}
    .btn{border:none;border-radius:999px;padding:10px 14px;background:var(--accent);color:#111;font-weight:700;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .wrap{max-width:1000px;margin:18px auto;padding:0 12px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:6px 0 14px}
    .badge{background:#15372f;border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:.9rem;color:var(--muted)}
    input[type="search"]{background:#0f241f;border:1px solid var(--line);border-radius:999px;padding:10px 12px;color:var(--text);min-width:240px;outline:none}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:8px}
    .day-group{margin-bottom:16px;border:1px solid var(--line);border-radius:var(--radius);overflow:hidden;background:var(--panel-2)}
    .day-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:rgba(255,255,255,.03);border-bottom:1px solid var(--line)}
    .day-title{display:flex;gap:10px;align-items:center;font-weight:800}
    .chip{border:1px solid var(--line);border-radius:999px;padding:4px 10px;font-size:.82rem;color:var(--muted)}
    .chip.today{border-color:var(--accent-2);color:#bfe8dc;background:rgba(46,122,98,.15)}
    .chip.tomorrow{border-color:#6e8cff;color:#d6e0ff;background:rgba(110,140,255,.12)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px 10px;border-bottom:1px solid rgba(255,255,255,.05);font-size:.95rem}
    th{color:var(--muted);font-weight:700;text-align:left}
    td .pill{display:inline-block;padding:4px 9px;border:1px solid var(--line);border-radius:999px;background:#122c26;color:#e8f7f2}
    tr.new-row{animation:flash 1.2s ease 1}
    @keyframes flash{0%{background:#15352d}100%{background:transparent}}
    .empty{color:var(--muted);text-align:center;padding:18px}
  </style>
</head>
<body>
  <header>
    <h1>üõéÔ∏è Monitor Prenotazioni</h1>
    <div style="display:flex;gap:8px;">
      <button id="notifyBtn" class="btn">Attiva notifiche</button>
      <button id="soundBtn" class="btn">Suono: ON</button>
    </div>
  </header>

  <div class="wrap">
    <div class="toolbar">
      <span class="badge">Aggiornamento: <span id="status">‚Äî</span></span>
      <input id="search" type="search" placeholder="Cerca in note/orario/data..." />
      <span class="badge">Nuove: <span id="newCount">0</span></span>
    </div>

    <div id="content"></div>
  </div>

<script>
  // === CONFIG ===
  const API = 'https://script.google.com/macros/s/AKfycbytvuxHvrg0XrMetUp6sa3_Rca9WInjUKZSSNo_TWNLKrb8NejXgbpZNEQfXotIGMWJ/exec';

  // === STATE ===
  let lastId = Number(localStorage.getItem('lastId') || 0);
  let soundOn = true;
  let items = []; // tutte le prenotazioni raccolte

  const $ = s => document.querySelector(s);

  // ---- Suono sintetizzato (nessun file esterno) ----
  let actx;
  function beep(){
    if(!soundOn) return;
    try{
      if(!actx) actx = new (window.AudioContext||window.webkitAudioContext)();
      const o = actx.createOscillator(); const g = actx.createGain();
      o.type='sine'; o.frequency.value=880;
      g.gain.setValueAtTime(0.001, actx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.2, actx.currentTime+0.02);
      g.gain.exponentialRampToValueAtTime(0.001, actx.currentTime+0.35);
      o.connect(g); g.connect(actx.destination); o.start(); o.stop(actx.currentTime+0.4);
    }catch(e){}
  }

  $('#soundBtn').addEventListener('click', ()=>{
    soundOn = !soundOn;
    $('#soundBtn').textContent = `Suono: ${soundOn?'ON':'OFF'}`;
    if(soundOn) beep();
  });

  $('#notifyBtn').addEventListener('click', async ()=>{
    try{
      const p = await Notification.requestPermission();
      if(p==='granted'){
        $('#notifyBtn').textContent='Notifiche attive';
        $('#notifyBtn').disabled=true;
        new Notification('Notifiche attive',{body:'Riceverai un avviso per ogni nuova prenotazione.'});
        beep();
      }else alert('Permesso negato dal browser.');
    }catch(e){ console.error(e); }
  });

  $('#search').addEventListener('input', render);

  // ---- Utility data ----
  const mesi = ['gennaio','febbraio','marzo','aprile','maggio','giugno','luglio','agosto','settembre','ottobre','novembre','dicembre'];

  function parseAnyDate(dStr){
    // accetta ISO o "18 settembre 2025"
    if(!dStr) return null;
    if(/T|\d{4}-\d{2}-\d{2}/.test(dStr)) {
      const d = new Date(dStr);
      if(!isNaN(d)) return new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    }
    // prova a leggere "gg mese italiano aaaa"
    const m = String(dStr).toLowerCase().match(/(\d{1,2})\s+([a-z√†√®√©√¨√≤√π]+)\s+(\d{4})/i);
    if(m){
      const day = Number(m[1]);
      const mi = mesi.indexOf(m[2]);
      const year = Number(m[3]);
      if(mi>=0) return new Date(Date.UTC(year, mi, day));
    }
    return null;
  }

  function formatItalianLong(d){
    // d √® Date (UTC)
    const day = String(d.getUTCDate()).padStart(1,'0');
    const month = mesi[d.getUTCMonth()];
    const year = d.getUTCFullYear();
    return `${day} ${month} ${year}`;
  }

  function isSameUTC(a,b){ return a.getUTCFullYear()===b.getUTCFullYear() && a.getUTCMonth()===b.getUTCMonth() && a.getUTCDate()===b.getUTCDate(); }

  // ---- Render con raggruppamento per giorno ----
  function render(){
    const q = $('#search').value.trim().toLowerCase();
    const cont = $('#content'); cont.innerHTML = '';

    // filtro + arricchimento
    const enriched = items
      .filter(r=>{
        if(!q) return true;
        return (String(r.id).includes(q)
          || String(r.timestamp||'').toLowerCase().includes(q)
          || String(r.dateRaw||'').toLowerCase().includes(q)
          || String(r.time||'').toLowerCase().includes(q)
          || String(r.people||'').toLowerCase().includes(q)
          || String(r.notes||'').toLowerCase().includes(q));
      })
      .map(r=>{
        const parsed = parseAnyDate(r.dateRaw);
        const dateKey = parsed ? parsed.toISOString().slice(0,10) : `txt:${(r.dateRaw||'').toLowerCase()}`;
        const displayDate = parsed ? formatItalianLong(parsed) : (r.datePretty || r.dateRaw || '');
        // badge oggi/domani
        const today = new Date(); const tUTC = new Date(Date.UTC(today.getFullYear(), today.getMonth(), today.getDate()));
        const tomorrowUTC = new Date(tUTC); tomorrowUTC.setUTCDate(tUTC.getUTCDate()+1);
        let badge = '';
        if(parsed){
          if(isSameUTC(parsed,tUTC)) badge = 'Oggi';
          else if(isSameUTC(parsed,tomorrowUTC)) badge = 'Domani';
        }
        return {...r, dateKey, displayDate, badge};
      });

    if(enriched.length===0){
      const empty = document.createElement('div'); empty.className='empty'; empty.textContent='Nessuna prenotazione.';
      cont.appendChild(empty); return;
    }

    // group by dateKey
    const groups = {};
    for(const it of enriched){
      if(!groups[it.dateKey]) groups[it.dateKey] = [];
      groups[it.dateKey].push(it);
    }

    // ordine gruppi: decrescente (pi√π recenti in alto)
    const order = Object.keys(groups).sort((a,b)=> (a>b?-1:1));

    for(const key of order){
      const list = groups[key].sort((a,b)=> b.id - a.id);

      // header giorno
      const d = document.createElement('section'); d.className='day-group';
      const head = document.createElement('div'); head.className='day-head';
      const title = document.createElement('div'); title.className='day-title';
      const mainTitle = document.createElement('span'); mainTitle.textContent = list[0].displayDate || 'Data';
      title.appendChild(mainTitle);
      if(list[0].badge){
        const badge = document.createElement('span'); badge.className='chip ' + (list[0].badge==='Oggi'?'today':'tomorrow'); badge.textContent = list[0].badge;
        title.appendChild(badge);
      }
      head.appendChild(title);
      head.appendChild(Object.assign(document.createElement('span'), {className:'chip', textContent:`${list.length} prenotaz.`}));
      d.appendChild(head);

      // tabellina del giorno
      const tbl = document.createElement('table');
      tbl.innerHTML = `
        <thead>
          <tr>
            <th style="width:84px;">ID</th>
            <th style="width:210px;">Prenotazione effettuata</th>
            <th style="width:110px;">Ora</th>
            <th style="width:110px;">Persone</th>
            <th>Note</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;
      const tb = tbl.querySelector('tbody');

      for(const r of list){
        const tr = document.createElement('tr');
        if(r._new) tr.classList.add('new-row');

        // timestamp: lo mostriamo com‚Äô√® (gi√† dd/MM/yyyy HH:mm:ss dal tuo backend)
        const ts = r.timestamp || '';
        tr.innerHTML = `
          <td>${r.id}</td>
          <td><span class="pill">${ts}</span></td>
          <td>${r.time || ''}</td>
          <td>${r.people || ''}</td>
          <td>${r.notes || ''}</td>
        `;
        tb.appendChild(tr);
        r._new = false;
      }

      d.appendChild(tbl);
      cont.appendChild(d);
    }
  }

  // ---- Polling via JSONP (no CORS) ----
  function poll(){
    const src = `${API}?since=${lastId||0}&callback=PV_JSONP`;
    const s = document.createElement('script');
    s.src = src; s.async = true;
    s.onerror = ()=> $('#status').textContent = 'Errore connessione';
    document.body.appendChild(s);
    setTimeout(()=> s.remove(), 10000);
  }

  // Callback globale JSONP
  function PV_JSONP(data){
    try{
      if(!data || !data.ok){ $('#status').textContent = 'API non ok'; return; }
      $('#status').textContent = `OK ${new Date().toLocaleTimeString()}`;

      if(Array.isArray(data.items) && data.items.length){
        // normalizza i campi per il nuovo renderer:
        // dal tuo doGet attuale: { id, timestamp, date (o ISO), time, people, notes }
        const normalized = data.items.map(x=>{
          return {
            id: x.id,
            timestamp: x.timestamp,        // "dd/MM/yyyy HH:mm:ss"
            dateRaw: x.date || x.dateISO,  // qualunque formato arrivi
            datePretty: x.date,            // se gi√† "18 settembre 2025"
            time: x.time,
            people: x.people,
            notes: x.notes,
            _new: true
          };
        });
        items = items.concat(normalized);
        render();

        lastId = data.lastId || lastId;
        localStorage.setItem('lastId', String(lastId));

        // feedback
        beep();
        if('Notification' in window && Notification.permission === 'granted'){
          const latest = normalized[normalized.length-1];
          new Notification('Nuova prenotazione', {
            body: `${latest.dateRaw ? '' : ''} Ora ${latest.time} ¬∑ Persone ${latest.people}${latest.notes? ' ¬∑ '+latest.notes:''}`
          });
        }
        const nc = document.getElementById('newCount');
        nc.textContent = String(Number(nc.textContent) + normalized.length);
      }
    }catch(e){
      console.error(e);
      $('#status').textContent = 'Errore parsing';
    }
  }
  window.PV_JSONP = PV_JSONP;

  // Avvio
  poll();
  setInterval(poll, 10000);
</script>
</body>
</html>
